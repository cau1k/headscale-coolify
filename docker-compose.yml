version: "3.9"

services:
  headscale-config:
    image: alpine:3.20
    restart: "no"
    environment:
      # Tailnet DNS base domain for MagicDNS.
      HEADSCALE_DNS_BASE_DOMAIN: ${HEADSCALE_DNS_BASE_DOMAIN:-tailnet.example.internal}

      # Optional overrides with sensible defaults.
      HEADSCALE_MAGIC_DNS: ${HEADSCALE_MAGIC_DNS:-true}
      HEADSCALE_IPV4_PREFIX: ${HEADSCALE_IPV4_PREFIX:-100.64.0.0/10}
      HEADSCALE_IPV6_PREFIX: ${HEADSCALE_IPV6_PREFIX:-fd7a:115c:a1e0::/48}
      HEADSCALE_DB_TYPE: ${HEADSCALE_DB_TYPE:-sqlite}
      HEADSCALE_DB_SQLITE_PATH: ${HEADSCALE_DB_SQLITE_PATH:-/var/lib/headscale/db.sqlite}
      HEADSCALE_LISTEN_ADDR: ${HEADSCALE_LISTEN_ADDR:-0.0.0.0:8080}
      HEADSCALE_METRICS_ADDR: ${HEADSCALE_METRICS_ADDR:-0.0.0.0:9090}
      HEADSCALE_LOG_LEVEL: ${HEADSCALE_LOG_LEVEL:-info}
    volumes:
      - headscale_config:/etc/headscale
      - headscale_run:/var/run/headscale
    command: >
      sh -c '
        set -eu;
        mkdir -p /etc/headscale /var/run/headscale;
        if [ -z "$HEADSCALE_DNS_BASE_DOMAIN" ]; then
          echo "HEADSCALE_DNS_BASE_DOMAIN is required" >&2; exit 1;
        fi;
        if [ -z "$SERVICE_FQDN_HEADSCALE" ]; then
          echo "SERVICE_FQDN_HEADSCALE is required (set by Coolify when you assign a domain)" >&2; exit 1;
        fi;
        cat > /etc/headscale/config.yaml <<EOF
        server_url: "https://$SERVICE_FQDN_HEADSCALE"
        listen_addr: "$HEADSCALE_LISTEN_ADDR"
        metrics_listen_addr: "$HEADSCALE_METRICS_ADDR"

        prefixes:
          v4: "$HEADSCALE_IPV4_PREFIX"
          v6: "$HEADSCALE_IPV6_PREFIX"

        database:
          type: "$HEADSCALE_DB_TYPE"
          sqlite:
            path: "$HEADSCALE_DB_SQLITE_PATH"

        dns:
          magic_dns: $HEADSCALE_MAGIC_DNS
          base_domain: "$HEADSCALE_DNS_BASE_DOMAIN"
          nameservers:
            global:
              - 1.1.1.1
              - 1.0.0.1
              - 8.8.8.8
              - 8.8.4.4

        log:
          level: "$HEADSCALE_LOG_LEVEL"
          format: "text"

        unix_socket: "/var/run/headscale/headscale.sock"
        unix_socket_permission: "0770"
        EOF
      '

  headscale:
    image: "headscale/headscale:0.27.1"
    container_name: "headscale"
    depends_on:
      headscale-config:
        condition: service_completed_successfully
    environment:
      HEADSCALE_DNS_BASE_DOMAIN: ${HEADSCALE_DNS_BASE_DOMAIN:-tailnet.example.internal}
      HEADSCALE_MAGIC_DNS: ${HEADSCALE_MAGIC_DNS:-true}
      HEADSCALE_IPV4_PREFIX: ${HEADSCALE_IPV4_PREFIX:-100.64.0.0/10}
      HEADSCALE_IPV6_PREFIX: ${HEADSCALE_IPV6_PREFIX:-fd7a:115c:a1e0::/48}
      HEADSCALE_DB_TYPE: ${HEADSCALE_DB_TYPE:-sqlite}
      HEADSCALE_DB_SQLITE_PATH: ${HEADSCALE_DB_SQLITE_PATH:-/var/lib/headscale/db.sqlite}
      HEADSCALE_LISTEN_ADDR: ${HEADSCALE_LISTEN_ADDR:-0.0.0.0:8080}
      HEADSCALE_METRICS_ADDR: ${HEADSCALE_METRICS_ADDR:-0.0.0.0:9090}
      HEADSCALE_LOG_LEVEL: ${HEADSCALE_LOG_LEVEL:-info}
    volumes:
      - headscale_config:/etc/headscale
      - headscale_data:/var/lib/headscale
      - headscale_run:/var/run/headscale
    command: ["serve"]
    restart: unless-stopped

volumes:
  headscale_config:
  headscale_data:
  headscale_run:
