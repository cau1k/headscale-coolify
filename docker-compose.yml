version: "3.9"

services:
  headscale-config:
    image: alpine:3.20
    restart: "no"
    environment:
      HEADSCALE_DNS_BASE_DOMAIN: ${HEADSCALE_DNS_BASE_DOMAIN:-tailnet.example.internal}
      HEADSCALE_MAGIC_DNS: ${HEADSCALE_MAGIC_DNS:-true}
      HEADSCALE_IPV4_PREFIX: ${HEADSCALE_IPV4_PREFIX:-100.64.0.0/10}
      HEADSCALE_IPV6_PREFIX: ${HEADSCALE_IPV6_PREFIX:-fd7a:115c:a1e0::/48}
      HEADSCALE_DB_TYPE: ${HEADSCALE_DB_TYPE:-sqlite}
      HEADSCALE_DB_SQLITE_PATH: ${HEADSCALE_DB_SQLITE_PATH:-/var/lib/headscale/db.sqlite}
      HEADSCALE_LISTEN_ADDR: ${HEADSCALE_LISTEN_ADDR:-0.0.0.0:8080}
      HEADSCALE_METRICS_ADDR: ${HEADSCALE_METRICS_ADDR:-0.0.0.0:9090}
      HEADSCALE_LOG_LEVEL: ${HEADSCALE_LOG_LEVEL:-info}
    volumes:
      - headscale_config:/etc/headscale
      - headscale_data:/var/lib/headscale
      - headscale_run:/var/run/headscale
    command:
      - /bin/sh
      - -c
      - |
        set -eu
        mkdir -p /etc/headscale /var/lib/headscale /var/run/headscale
        if [ -z "$HEADSCALE_DNS_BASE_DOMAIN" ]; then
          echo "HEADSCALE_DNS_BASE_DOMAIN is required" >&2
          exit 1
        fi
        if [ -z "$SERVICE_FQDN_HEADSCALE" ]; then
          echo "SERVICE_FQDN_HEADSCALE is required (set by Coolify when you assign a domain)" >&2
          exit 1
        fi
        {
          printf 'server_url: "%s"\n' "https://$SERVICE_FQDN_HEADSCALE"
          printf 'listen_addr: "%s"\n' "$HEADSCALE_LISTEN_ADDR"
          printf 'metrics_listen_addr: "%s"\n' "$HEADSCALE_METRICS_ADDR"
          printf '\n'
          printf 'noise:\n'
          printf '  private_key_path: "/var/lib/headscale/noise_private.key"\n'
          printf '\n'
          printf 'prefixes:\n'
          printf '  v4: "%s"\n' "$HEADSCALE_IPV4_PREFIX"
          printf '  v6: "%s"\n' "$HEADSCALE_IPV6_PREFIX"
          printf '\n'
          printf 'database:\n'
          printf '  type: "%s"\n' "$HEADSCALE_DB_TYPE"
          printf '  sqlite:\n'
          printf '    path: "%s"\n' "$HEADSCALE_DB_SQLITE_PATH"
          printf '\n'
          printf 'derp:\n'
          printf '  urls:\n'
          printf '    - https://controlplane.tailscale.com/derpmap/default\n'
          printf '  paths: []\n'
          printf '  auto_update_enabled: true\n'
          printf '  update_frequency: 3h\n'
          printf '\n'
          printf 'dns:\n'
          printf '  magic_dns: %s\n' "$HEADSCALE_MAGIC_DNS"
          printf '  base_domain: "%s"\n' "$HEADSCALE_DNS_BASE_DOMAIN"
          printf '  nameservers:\n'
          printf '    global:\n'
          printf '      - 1.1.1.1\n'
          printf '      - 1.0.0.1\n'
          printf '      - 8.8.8.8\n'
          printf '      - 8.8.4.4\n'
          printf '\n'
          printf 'log:\n'
          printf '  level: "%s"\n' "$HEADSCALE_LOG_LEVEL"
          printf '  format: "text"\n'
          printf '\n'
          printf 'unix_socket: "/var/run/headscale/headscale.sock"\n'
          printf 'unix_socket_permission: "0770"\n'
        } > /etc/headscale/config.yaml

  headscale-init:
    image: "headscale/headscale:0.27.1-debug"
    restart: "no"
    depends_on:
      headscale-config:
        condition: service_completed_successfully
    environment:
      HEADSCALE_DNS_BASE_DOMAIN: ${HEADSCALE_DNS_BASE_DOMAIN:-tailnet.example.internal}
      HEADSCALE_MAGIC_DNS: ${HEADSCALE_MAGIC_DNS:-true}
      HEADSCALE_IPV4_PREFIX: ${HEADSCALE_IPV4_PREFIX:-100.64.0.0/10}
      HEADSCALE_IPV6_PREFIX: ${HEADSCALE_IPV6_PREFIX:-fd7a:115c:a1e0::/48}
      HEADSCALE_DB_TYPE: ${HEADSCALE_DB_TYPE:-sqlite}
      HEADSCALE_DB_SQLITE_PATH: ${HEADSCALE_DB_SQLITE_PATH:-/var/lib/headscale/db.sqlite}
      HEADSCALE_LISTEN_ADDR: ${HEADSCALE_LISTEN_ADDR:-0.0.0.0:8080}
      HEADSCALE_METRICS_ADDR: ${HEADSCALE_METRICS_ADDR:-0.0.0.0:9090}
      HEADSCALE_LOG_LEVEL: ${HEADSCALE_LOG_LEVEL:-info}
    volumes:
      - headscale_config:/etc/headscale
      - headscale_data:/var/lib/headscale
      - headscale_run:/var/run/headscale
    command:
      - /bin/sh
      - -c
      - |
        set -eu
        echo "[headscale-init] Creating namespace 'default' if needed..."
        headscale namespaces create default || true
        echo "[headscale-init] Creating reusable preauth key for namespace 'default' (no expiration)..."
        headscale preauthkeys create --namespace default --reusable

  headscale:
    image: "headscale/headscale:0.27.1-debug"
    container_name: "headscale"
    depends_on:
      headscale-config:
        condition: service_completed_successfully
      headscale-init:
        condition: service_completed_successfully
    environment:
      HEADSCALE_DNS_BASE_DOMAIN: ${HEADSCALE_DNS_BASE_DOMAIN:-tailnet.example.internal}
      HEADSCALE_MAGIC_DNS: ${HEADSCALE_MAGIC_DNS:-true}
      HEADSCALE_IPV4_PREFIX: ${HEADSCALE_IPV4_PREFIX:-100.64.0.0/10}
      HEADSCALE_IPV6_PREFIX: ${HEADSCALE_IPV6_PREFIX:-fd7a:115c:a1e0::/48}
      HEADSCALE_DB_TYPE: ${HEADSCALE_DB_TYPE:-sqlite}
      HEADSCALE_DB_SQLITE_PATH: ${HEADSCALE_DB_SQLITE_PATH:-/var/lib/headscale/db.sqlite}
      HEADSCALE_LISTEN_ADDR: ${HEADSCALE_LISTEN_ADDR:-0.0.0.0:8080}
      HEADSCALE_METRICS_ADDR: ${HEADSCALE_METRICS_ADDR:-0.0.0.0:9090}
      HEADSCALE_LOG_LEVEL: ${HEADSCALE_LOG_LEVEL:-info}
    volumes:
      - headscale_config:/etc/headscale
      - headscale_data:/var/lib/headscale
      - headscale_run:/var/run/headscale
    command: ["serve"]
    restart: unless-stopped

volumes:
  headscale_config:
  headscale_data:
  headscale_run:
